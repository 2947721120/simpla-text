<link rel="import" href="../polymer/polymer.html">

<dom-module id="simpla-text">
  <template>
    <style>
      :host, *, *::before, *::after {
        box-sizing: border-box;
      }

      :host {
        -moz-osx-font-smoothing: grayscale;
         -webkit-font-smoothing: antialiased;
                 font-smoothing: antialiased;

        outline: none;
      }

      .toolbar-wrapper {
        position: relative;
      }

      .toolbar {
        position: absolute;
      }
    </style>
    <div class="toolbar-wrapper">
      <simpla-text-toolbar id="toolbar" class="toolbar" on-command="_handleToolbarCommand" hidden>
      </simpla-text-toolbar>
    </div>
    <slot></slot>
  </template>

  <script>(function () {
'use strict';

var EDITOR_COMPONENT = 'simpla-text-editor.html';

var editor = {
  properties: {
    commands: {
      type: Array,
      computed: '_computeCommands(plaintext)'
    }
  },

  observers: ['_checkEditorPrepped(editable, commands, inline)'],

  getEditor: function getEditor() {
    var _this = this;

    return Promise.resolve(this._editor || this._createEditor()).then(function (editor) {
      _this._editor = editor;
      return editor;
    });
  },
  runCommand: function runCommand(commandName) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

    return this.getEditor().then(function (editor) {
      return editor.runCommand(commandName, options);
    });
  },
  _createEditor: function _createEditor() {
    var _this2 = this;

    if (!this.__waitForEditor) {
      this.__waitForEditor = new Promise(function (resolve, reject) {
        var editorUrl = _this2.resolveUrl(EDITOR_COMPONENT);
        _this2.importHref(editorUrl, resolve, reject);
      }).then(function () {
        var Editor = window.SimplaText.Editor,
            toFormatter = function toFormatter(command) {
          return Editor.formatters[command];
        };

        return new Editor({
          dom: _this2,
          inline: _this2.inline,
          formatters: _this2.commands.map(toFormatter),
          editableCallback: function editableCallback() {
            return _this2.editable;
          }
        });
      });
    }

    return this.__waitForEditor;
  },
  _checkEditorPrepped: function _checkEditorPrepped(editable) {
    if (editable) {
      this.getEditor();
    }
  },
  _computeCommands: function _computeCommands(plaintext) {
    return plaintext ? [] : ['bold', 'italic', 'underline'];
  }
};

var INLINE_ELEMENTS = ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'li', 'dd', 'figcaption', 'mark', 'q', 's', 'time', 'u', 'legend', 'option', 'b', 'big', 'i', 'small', 'tt', 'abbr', 'acronym', 'cite', 'pre', 'code', 'dfn', 'em', 'kbd', 'strong', 'samp', 'var', 'a', 'span', 'sub', 'sup', 'button', 'label'];

var inlineBlock = {
  properties: {
    inline: {
      type: Boolean,
      observer: '_inlineObserver'
    },

    block: {
      type: Boolean,
      observer: '_blockObserver'
    }
  },

  attached: function attached() {
    this._autoSetMode();
  },
  _inlineObserver: function _inlineObserver(inline) {
    this.block = !inline;
  },
  _blockObserver: function _blockObserver(block) {
    this.inline = !block;
  },
  _autoSetMode: function _autoSetMode() {
    var parentName = this.parentElement && this.parentElement.nodeName.toLowerCase();

    if (typeof this.inline !== 'undefined' || typeof this.block !== 'undefined') {
      return;
    }

    this.inline = INLINE_ELEMENTS.indexOf(parentName) !== -1;
  }
};

var simpla = {
  properties: {
    editable: {
      type: Boolean,
      reflectToAttribute: true,
      value: function value() {
        return Simpla.getState('editable');
      }
    },

    uid: {
      type: String,
      observer: '_observeUid'
    }
  },

  listeners: {
    'input': '_setToSimpla'
  },

  attached: function attached() {
    var _this = this;

    this._observers = {
      editable: Simpla.observeState('editable', function (editable) {
        _this.editable = editable;
      })
    };

    if (this.uid) {
      this._attachUidObserver();
    }

    this._attached = true;
  },
  detached: function detached() {
    var _this2 = this;

    Object.keys(this._observers || {}).map(function (prop) {
      return _this2._observers[prop];
    }).forEach(function (observer) {
      return observer.unobserve();
    });
  },
  _observeUid: function _observeUid(uid) {
    var _this3 = this;

    if (this._attached && uid) {
      Simpla.get(uid).then(function (item) {
        return _this3._restoreFromSimpla(item);
      });
      this._attachUidObserver();
    }
  },
  _attachUidObserver: function _attachUidObserver() {
    var _this4 = this;

    if (this._observers.uid) {
      this._observers.uid.unobserve();
    }

    this._observers.uid = Simpla.observe(this.uid, function (item) {
      return _this4._restoreFromSimpla(item);
    });
  },
  _restoreFromSimpla: function _restoreFromSimpla(item) {
    var data = void 0;

    if (!item) {
      return;
    }

    data = item.data;

    if (this.innerHTML !== data.html) {
      this.innerHTML = data.html;
    }
  },
  _setToSimpla: function _setToSimpla() {
    if (!this.uid) {
      return;
    }

    Simpla.set(this.uid, {
      type: 'Text',
      data: {
        html: this.innerHTML
      }
    });
  }
};

var classCallCheck = function (instance, Constructor) {
  if (!(instance instanceof Constructor)) {
    throw new TypeError("Cannot call a class as a function");
  }
};

var createClass = function () {
  function defineProperties(target, props) {
    for (var i = 0; i < props.length; i++) {
      var descriptor = props[i];
      descriptor.enumerable = descriptor.enumerable || false;
      descriptor.configurable = true;
      if ("value" in descriptor) descriptor.writable = true;
      Object.defineProperty(target, descriptor.key, descriptor);
    }
  }

  return function (Constructor, protoProps, staticProps) {
    if (protoProps) defineProperties(Constructor.prototype, protoProps);
    if (staticProps) defineProperties(Constructor, staticProps);
    return Constructor;
  };
}();







var get$1 = function get$1(object, property, receiver) {
  if (object === null) object = Function.prototype;
  var desc = Object.getOwnPropertyDescriptor(object, property);

  if (desc === undefined) {
    var parent = Object.getPrototypeOf(object);

    if (parent === null) {
      return undefined;
    } else {
      return get$1(parent, property, receiver);
    }
  } else if ("value" in desc) {
    return desc.value;
  } else {
    var getter = desc.get;

    if (getter === undefined) {
      return undefined;
    }

    return getter.call(receiver);
  }
};

















var set$1 = function set$1(object, property, value, receiver) {
  var desc = Object.getOwnPropertyDescriptor(object, property);

  if (desc === undefined) {
    var parent = Object.getPrototypeOf(object);

    if (parent !== null) {
      set$1(parent, property, value, receiver);
    }
  } else if ("value" in desc && desc.writable) {
    desc.value = value;
  } else {
    var setter = desc.set;

    if (setter !== undefined) {
      setter.call(receiver, value);
    }
  }

  return value;
};















var toConsumableArray = function (arr) {
  if (Array.isArray(arr)) {
    for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) arr2[i] = arr[i];

    return arr2;
  } else {
    return Array.from(arr);
  }
};

var toolbar = {
  listeners: {
    'select': '_updateToolbarFromSelect',
    'formatter-updated': '_handleFormatterUpdated',
    'blur': '_hideToolbar'
  },

  _hideToolbar: function _hideToolbar() {
    this.$.toolbar.hidden = true;
  },
  _handleToolbarCommand: function _handleToolbarCommand(event) {
    var _event$detail = event.detail,
        name = _event$detail.name,
        _event$detail$options = _event$detail.options,
        options = _event$detail$options === undefined ? {} : _event$detail$options;


    this.runCommand(name, options);
  },
  _updateToolbarFromSelect: function _updateToolbarFromSelect(event) {
    var selection = event.detail.selection;


    if (this.plaintext) {
      this.$.toolbar.hidden = true;
      return;
    }

    this.$.toolbar.hidden = !selection;
    this.$.toolbar.hoverOverSelection(selection);
  },
  _handleFormatterUpdated: function _handleFormatterUpdated(event) {
    var _event$detail2 = event.detail,
        name = _event$detail2.name,
        state = _event$detail2.state,
        toolbar = this.$.toolbar;


    if (state.applied) {
      toolbar.activeTools = [].concat(toConsumableArray(toolbar.activeTools), [name]);
    } else {
      toolbar.activeTools = toolbar.activeTools.filter(function (tool) {
        return tool !== name;
      });
    }
  }
};

var SimplaText = function () {
  function SimplaText() {
    classCallCheck(this, SimplaText);
  }

  createClass(SimplaText, [{
    key: 'beforeRegister',
    value: function beforeRegister() {
      this.properties = {
        editing: {
          type: Boolean,
          readOnly: true,
          value: false
        },

        editable: {
          type: Boolean,
          reflectToAttribute: true,
          value: false
        },

        plaintext: {
          type: Boolean,
          value: false
        }
      };

      this.listeners = {
        'tap': '_handleTap',
        'blur': '_handleBlur',
        'focus': '_handleFocus'
      };
    }
  }, {
    key: '_handleBlur',
    value: function _handleBlur() {
      this._setEditing(false);
    }
  }, {
    key: '_handleFocus',
    value: function _handleFocus() {
      if (this.editable) {
        this._setEditing(true);
      }
    }
  }, {
    key: '_handleTap',
    value: function _handleTap() {
      if (this.editable) {
        this._setEditing(true);
      }
    }
  }, {
    key: '_editableObserver',
    value: function _editableObserver(editable) {
      if (!editable) {
        this._setEditing(false);
      }
    }
  }, {
    key: 'behaviors',
    get: function get() {
      return [editor, inlineBlock, simpla, toolbar];
    }
  }, {
    key: 'value',
    get: function get() {
      return this.innerHTML;
    },
    set: function set(value) {
      this.innerHTML = value;
    }
  }]);
  return SimplaText;
}();



Polymer(SimplaText);

}());
</script>
</dom-module>
